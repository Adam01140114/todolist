<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List App</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1><i class="fas fa-tasks"></i> My Todo List</h1>
            <div class="stats">
                <span class="total-todos">0</span> tasks
            </div>
        </header>

        <div class="add-todo-section">
            <div class="input-container">
                <input type="text" id="todoInput" placeholder="Add a new task..." maxlength="100">
                <button id="addBtn" class="add-btn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>

        <div class="todos-container">
            <div class="todos-section">
                <h2 class="section-title">
                    <i class="fas fa-star"></i> Important Tasks
                    <span class="count" id="importantCount">0</span>
                </h2>
                <div id="importantTodos" class="todo-list important-list">
                    <!-- Important todos will be added here -->
                </div>
            </div>

            <div class="todos-section">
                <h2 class="section-title">
                    <i class="fas fa-list"></i> All Tasks
                    <span class="count" id="allCount">0</span>
                </h2>
                <div id="allTodos" class="todo-list all-list">
                    <!-- Regular todos will be added here -->
                </div>
            </div>
        </div>

        <div class="empty-state" id="emptyState">
            <i class="fas fa-clipboard-list"></i>
            <h3>No tasks yet</h3>
            <p>Add your first task above to get started!</p>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCZUp1CSYlsVgzhttkziCLWEnReTw8dm68",
            authDomain: "todolis-a32fe.firebaseapp.com",
            projectId: "todolis-a32fe",
            storageBucket: "todolis-a32fe.firebasestorage.app",
            messagingSenderId: "129292823003",
            appId: "1:129292823003:web:40c8154872e8740c1edffe",
            measurementId: "G-T9DDSCTQFX",
            databaseURL: "https://todolis-a32fe-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const todosRef = ref(database, 'todos');

        class TodoApp {
            constructor() {
                this.todos = [];
                this.initializeElements();
                this.setupEventListeners();
                this.loadTodos();
            }

            initializeElements() {
                this.todoInput = document.getElementById('todoInput');
                this.addBtn = document.getElementById('addBtn');
                this.importantTodos = document.getElementById('importantTodos');
                this.allTodos = document.getElementById('allTodos');
                this.emptyState = document.getElementById('emptyState');
                this.loadingOverlay = document.getElementById('loadingOverlay');
                this.totalTodos = document.querySelector('.total-todos');
                this.importantCount = document.getElementById('importantCount');
                this.allCount = document.getElementById('allCount');
            }

            setupEventListeners() {
                this.addBtn.addEventListener('click', () => this.addTodo());
                this.todoInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addTodo();
                });
            }

            async loadTodos() {
                this.showLoading(true);
                try {
                    onValue(todosRef, (snapshot) => {
                        this.todos = [];
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            Object.keys(data).forEach(key => {
                                this.todos.push({ id: key, ...data[key] });
                            });
                        }
                        this.renderTodos();
                        this.updateStats();
                        this.showLoading(false);
                    });
                } catch (error) {
                    console.error('Error loading todos:', error);
                    this.showLoading(false);
                }
            }

            async addTodo() {
                const text = this.todoInput.value.trim();
                if (!text) return;

                const todo = {
                    text: text,
                    completed: false,
                    important: false,
                    createdAt: Date.now(),
                    order: this.todos.length
                };

                try {
                    await push(todosRef, todo);
                    this.todoInput.value = '';
                } catch (error) {
                    console.error('Error adding todo:', error);
                }
            }

            async toggleImportant(todoId) {
                const todo = this.todos.find(t => t.id === todoId);
                if (!todo) return;

                const todoRef = ref(database, `todos/${todoId}`);
                await update(todoRef, { important: !todo.important });
            }

            async toggleCompleted(todoId) {
                const todo = this.todos.find(t => t.id === todoId);
                if (!todo) return;

                const todoRef = ref(database, `todos/${todoId}`);
                await update(todoRef, { completed: !todo.completed });
            }

            async deleteTodo(todoId) {
                const todoRef = ref(database, `todos/${todoId}`);
                await remove(todoRef);
            }

            async updateOrder(todoId, newOrder) {
                const todoRef = ref(database, `todos/${todoId}`);
                await update(todoRef, { order: newOrder });
            }

            renderTodos() {
                const importantTodos = this.todos
                    .filter(todo => todo.important && !todo.completed)
                    .sort((a, b) => (a.order || 0) - (b.order || 0));

                const regularTodos = this.todos
                    .filter(todo => !todo.important && !todo.completed)
                    .sort((a, b) => (a.order || 0) - (b.order || 0));

                this.renderTodoList(importantTodos, this.importantTodos, true);
                this.renderTodoList(regularTodos, this.allTodos, false);

                this.emptyState.style.display = this.todos.length === 0 ? 'block' : 'none';
            }

            renderTodoList(todos, container, isImportant) {
                container.innerHTML = '';

                todos.forEach(todo => {
                    const todoElement = this.createTodoElement(todo, isImportant);
                    container.appendChild(todoElement);
                });

                // Make the list sortable
                this.makeSortable(container, isImportant);
            }

            createTodoElement(todo, isImportant) {
                const todoDiv = document.createElement('div');
                todoDiv.className = `todo-item ${todo.completed ? 'completed' : ''}`;
                todoDiv.draggable = true;
                todoDiv.dataset.todoId = todo.id;

                todoDiv.innerHTML = `
                    <div class="todo-content">
                        <button class="complete-btn ${todo.completed ? 'completed' : ''}" 
                                onclick="app.toggleCompleted('${todo.id}')">
                            <i class="fas fa-check"></i>
                        </button>
                        <span class="todo-text">${this.escapeHtml(todo.text)}</span>
                        <div class="todo-actions">
                            <button class="important-btn ${todo.important ? 'important' : ''}" 
                                    onclick="app.toggleImportant('${todo.id}')" 
                                    title="${todo.important ? 'Remove from important' : 'Mark as important'}">
                                <i class="fas fa-star"></i>
                            </button>
                            <button class="delete-btn" onclick="app.deleteTodo('${todo.id}')" title="Delete task">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;

                return todoDiv;
            }

            makeSortable(container, isImportant) {
                let draggedElement = null;

                container.addEventListener('dragstart', (e) => {
                    draggedElement = e.target;
                    e.target.style.opacity = '0.5';
                });

                container.addEventListener('dragend', (e) => {
                    e.target.style.opacity = '1';
                    draggedElement = null;
                });

                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = this.getDragAfterElement(container, e.clientY);
                    if (afterElement == null) {
                        container.appendChild(draggedElement);
                    } else {
                        container.insertBefore(draggedElement, afterElement);
                    }
                });

                container.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    if (!draggedElement) return;

                    const todos = Array.from(container.children);
                    const newIndex = todos.indexOf(draggedElement);
                    
                    // Update order for all todos in this section
                    for (let i = 0; i < todos.length; i++) {
                        const todoId = todos[i].dataset.todoId;
                        await this.updateOrder(todoId, i);
                    }
                });
            }

            getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.todo-item:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            updateStats() {
                const total = this.todos.length;
                const important = this.todos.filter(todo => todo.important && !todo.completed).length;
                const all = this.todos.filter(todo => !todo.completed).length;

                this.totalTodos.textContent = total;
                this.importantCount.textContent = important;
                this.allCount.textContent = all;
            }

            showLoading(show) {
                this.loadingOverlay.style.display = show ? 'flex' : 'none';
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize the app
        window.app = new TodoApp();
    </script>
</body>
</html>
